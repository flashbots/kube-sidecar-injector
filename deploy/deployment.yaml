---

kind: Deployment
apiVersion: apps/v1
metadata:
  name: kube-sidecar-injector
  labels:
    app.kubernetes.io/name: kube-sidecar-injector
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kube-sidecar-injector
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kube-sidecar-injector
    spec:
      serviceAccountName: kube-sidecar-injector
      containers:
        - name: kube-sidecar-injector
          image: kube-sidecar-injector:0.0.2-dev
          ports:
            - name: https
              containerPort: 8443
          volumeMounts:
            - name: config
              mountPath: /etc/kube-sidecar-injector
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: kube-sidecar-injector
            items:
              - key: config.yaml
                path: config.yaml

---

kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-sidecar-injector
data:
  config.yaml: |-
    inject:
      - containers:
          - name: node-exporter
            image: prom/node-exporter:v1.7.0
            args: [
              "--log.format", "json",
              "--web.listen-address", ":9001",
            ]
            ports:
              - name: metrics
                containerPort: 9001
            resources:
              requests:
                cpu: 10m
                memory: 64Mi

        labelSelector:
          matchExpressions:
            - key: eks.amazonaws.com/fargate-profile
              operator: Exists

---

kind: Service
apiVersion: v1
metadata:
  name: kube-sidecar-injector
  labels:
    app.kubernetes.io/name: kube-sidecar-injector
spec:
  selector:
    app.kubernetes.io/name: kube-sidecar-injector
  ports:
    - name: https
      port: 8443
      targetPort: 8443

---

kind: ServiceAccount
apiVersion: v1
metadata:
  name: kube-sidecar-injector
  labels:
    app.kubernetes.io/name: kube-sidecar-injector

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: kube-sidecar-injector
  labels:
    app.kubernetes.io/name: kube-sidecar-injector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kube-sidecar-injector
subjects:
  - kind: ServiceAccount
    name: kube-sidecar-injector
    namespace: default
